# セキュリティ

このドキュメントでは、Paste Image as WebPプラグインのセキュリティ機能と対策について説明します。

## 実装されているセキュリティ対策

### 1. パストラバーサル攻撃の防止

**脅威**: 悪意のあるパス（`../../../etc/passwd`など）を使用してVault外部にファイルを書き込む

**対策**:
- すべてのファイル名とフォルダパスをサニタイズ
- `..`（親ディレクトリ参照）を削除
- パス区切り文字（`/`, `\`）をファイル名から削除
- 絶対パスを拒否
- null byteを削除

**実装箇所**: `main.ts:61-112`

### 2. リソース消費攻撃（DoS）の防止

**脅威**: 巨大な画像（例: 10000×10000ピクセル）をペーストしてメモリを枯渇させる

**対策**:
- 画像の最大ピクセル数制限（デフォルト: 16,777,216 = 4096×4096）
- 画像の最大ファイルサイズ制限（デフォルト: 10MB）
- 画像寸法の健全性チェック（0以下、16384超を拒否）

**設定可能項目**:
- `maxImageSize`: 最大ピクセル数（width × height）
- `maxFileSizeMB`: 最大ファイルサイズ（MB）

**実装箇所**: `main.ts:117-137`, `main.ts:167`, `main.ts:216`

### 3. ファイル名インジェクションの防止

**脅威**: 特殊文字を含むファイル名（`<>:"|?*`など）でファイルシステムエラーを引き起こす

**対策**:
- OS依存の危険な文字を置換（`<>:"|?*`など）
- 制御文字（0x00-0x1F）を削除
- ファイル名の長さを255文字に制限
- 先頭/末尾のドットと空白を削除

**実装箇所**: `main.ts:61-82`

### 4. 無限ループの防止

**脅威**: 重複ファイル名チェックで無限ループに陥る

**対策**:
- 重複ファイル名の試行回数を1000回に制限
- 上限に達した場合はエラーメッセージを表示

**実装箇所**: `main.ts:302-305`

### 5. 情報漏洩の防止

**脅威**: 詳細なエラーメッセージでシステム情報が漏洩する

**対策**:
- エラーメッセージをフィルタリング
- 既知の安全なメッセージのみ表示
- それ以外は汎用的なメッセージに置換
- 詳細なエラーはコンソールにのみ記録

**実装箇所**: `main.ts:193-205`

## セキュリティ設定の推奨値

### 一般ユーザー（デフォルト）
```
最大画像サイズ: 16,777,216 ピクセル (4096×4096)
最大ファイルサイズ: 10MB
WebP品質: 0.85
```

### 高セキュリティ環境
```
最大画像サイズ: 4,194,304 ピクセル (2048×2048)
最大ファイルサイズ: 5MB
WebP品質: 0.75
```

### パワーユーザー
```
最大画像サイズ: 67,108,864 ピクセル (8192×8192)
最大ファイルサイズ: 50MB
WebP品質: 0.95
```

**注意**: 値を大きくするとリソース消費が増加します

## 既知の制限事項

### 1. Obsidian API依存
- ファイル操作はObsidian Vault APIに依存
- API自体のセキュリティに依存

### 2. ブラウザ環境
- Canvas APIの制限を受ける
- 一部のブラウザでWebPが未サポートの可能性

### 3. クリップボードアクセス
- クリップボードから読み取る画像データを信頼
- ユーザーが信頼できないソースから画像をコピーした場合、画像自体が悪意のあるペイロードを含む可能性

## セキュリティベストプラクティス

### プラグイン利用者向け

1. **信頼できるソースからのみ画像をペースト**
   - 不明なWebサイトやメールからの画像に注意

2. **適切なセキュリティ設定を使用**
   - 用途に応じて最大サイズを調整
   - 不必要に大きな値を設定しない

3. **定期的な更新**
   - プラグインを最新バージョンに保つ
   - セキュリティパッチを適用

### プラグイン開発者向け

1. **入力検証**
   - すべてのユーザー入力を検証
   - ホワイトリスト方式を優先

2. **エラーハンドリング**
   - 詳細なエラーはログに記録
   - ユーザーには汎用的なメッセージを表示

3. **リソース制限**
   - メモリ消費を制限
   - タイムアウトを設定

## 脆弱性の報告

セキュリティ上の問題を発見した場合は、以下の方法で報告してください：

1. **GitHub Issues**: https://github.com/CocoaAI-IT/obsidian_exteition/issues
2. 機密性の高い問題の場合は、Issueでプライベートな連絡方法を要求してください

### 報告に含めるべき情報

- 脆弪性の詳細な説明
- 再現手順
- 影響範囲
- 可能であれば修正案

## セキュリティ監査履歴

### 2024-11 初回セキュリティレビュー

**発見された問題**:
- 🔴 高: パストラバーサル脆弱性
- 🟡 中: リソース消費攻撃（DoS）
- 🟡 中: ファイル名サニタイズ不足
- 🟢 低: 無限ループの可能性
- 🟢 低: エラーメッセージの情報漏洩

**対応状況**: すべて修正済み

## ライセンス

このセキュリティドキュメントはプラグイン本体と同じMITライセンスの下で提供されます。
